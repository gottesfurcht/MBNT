(setq make-backup-files nil)

(defun gnt-process-paragraph (chapter)
  (kill-whole-line)
  (push-mark)
  (forward-to-indentation)
  (delete-region (point) (mark))
  (push-mark)
  (forward-paragraph)
  (narrow-to-region (point) (mark))
  (while (> (point) (point-min))
    (delete-indentation))
  (while (re-search-forward verse-regex nil t)
    (replace-match (concat "\n$$$" book " " chapter ":\\1\n")))
  (narrow-to-page))

(defun gnt-convert (file)
  (with-current-buffer (find-file-noselect file)
    (let* ((book (substring file 0 -4))
           (chapter-regex "Κεφάλαιο \\([0-9]+\\)")
           (verse-regex "\\([0-9]+\\) ")
           chapter)
      (goto-char (point-min))
      (push-mark)
      (if (re-search-forward chapter-regex nil t)
          (progn (beginning-of-line)
                 (delete-region (point) (mark))
                 (while (re-search-forward chapter-regex nil t)
                   (gnt-process-paragraph (match-string 1))))
        (gnt-process-paragraph "1"))
      (forward-line)
      (delete-region (point) (point-max))
      (write-file (expand-file-name (concat book ".imp"))))))

(let ((default-directory (expand-file-name "texts")))
  (mapc 'gnt-convert (directory-files "." nil "^[0-9a-zA-z ]+\\.txt$")))
